> # ============================================================
> # Appendix K COMPLETE — CPS Replication (Table K1; K2–K5)
> # R 4.5.2 (2025-10-31 ucrt), Windows x86_64
> # ============================================================
> # What this script produces (in ./outputs):
> #   - table_k1_cps_singlehood_rates_25_34.csv
> #   - k2_did_estimates.csv
> #   - figure_k1_event_study_coefficients.csv
> #   - figure_k1_event_study_plotdata.csv
> #   - figure_k1_joint_pretrend_tests.csv
> #   - figure_k1_pre_slope_test.csv
> #   - figure_k1_event_study.png
> #   - figure_k2_its_predicted_levels.csv
> #   - its_key_coefficients_two_way_clustered.csv
> #   - its_pretrend_test.csv
> #   - figure_k2_its_predicted_levels_overlay.png
> #   - figure_k2_its_predicted_levels_panels.png
> #   - k5a_clustering_sensitivity_its_key_terms.csv
> #   - breakpoint_sensitivity_2009_2015.csv
> #   - breakpoint_sensitivity_2009_2015.png
> #   - sessionInfo.txt
> #
> # Core outcome: single01 = 1 if NOT married AND NOT cohabiting.
> # Cohab proxy: PECOHAB > 0; if missing/NA, treated as FALSE (conservative).
> # Weights: prefer ASECWT when available and >0, else WTFINL.
> # SEs: clustered via sandwich::vcovCL (HC1) with three variants:
> #   (i) YEAR-only, (ii) birth_year-only, (iii) two-way (birth_year & YEAR)
> # ============================================================
> 
> # -----------------------------
> # 0) Packages (fail fast)
> # -----------------------------
> req_pkgs <- c("dplyr","tidyr","readr","ggplot2","ipumsr","sandwich","lmtest","broom","tibble")
> missing <- req_pkgs[!vapply(req_pkgs, requireNamespace, logical(1), quietly = TRUE)]
> if (length(missing) > 0) {
+   stop("Missing packages: ", paste(missing, collapse = ", "),
+        "\nInstall with install.packages(c(", paste(sprintf('"%s"', missing), collapse = ", "), "))")
+ }
> suppressPackageStartupMessages({
+   library(dplyr)
+   library(tidyr)
+   library(readr)
+   library(ggplot2)
+   library(ipumsr)
+   library(sandwich)
+   library(lmtest)
+   library(broom)
+   library(tibble)
+ })
> 
> # -----------------------------
> # 1) USER SETTINGS
> # -----------------------------
> # CHANGE THIS to your CPS folder
> data_dir <- "C:/Users/joshu/Downloads/Chad Debate/CPS data/1962Present"
> ddi_file <- file.path(data_dir, "cps_00002.xml")
> dat_file <- file.path(data_dir, "cps_00002.dat.gz")
> 
> out_dir <- "outputs"
> if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE)
> 
> set.seed(1)
> 
> # -----------------------------
> # 2) LOAD CPS (IPUMS)
> # -----------------------------
> ddi <- read_ipums_ddi(ddi_file)
> cps <- read_ipums_micro(ddi, data_file = dat_file)
Use of data from IPUMS CPS is subject to conditions including that users should cite the data appropriately. Use command `ipums_conditions()` for more details.

|                                                                                     |   0%    6 MB
|                                                                                     |   0%    7 MB
|                                                                                     |   0%    8 MB
|                                                                                     |   1%   10 MB
|=                                                                                    |   1%   11 MB
|=                                                                                    |   1%   12 MB
|=                                                                                    |   1%   13 MB
|=                                                                                    |   1%   15 MB
|=                                                                                    |   1%   17 MB
|=                                                                                    |   1%   18 MB
|=                                                                                    |   2%   20 MB
|==                                                                                   |   2%   22 MB
|==                                                                                   |   2%   24 MB
|==                                                                                   |   2%   26 MB
|==                                                                                   |   3%   28 MB
|==                                                                                   |   3%   30 MB
|==                                                                                   |   3%   32 MB
|===                                                                                  |   3%   34 MB
|===                                                                                  |   3%   36 MB
|===                                                                                  |   4%   38 MB
|===                                                                                  |   4%   40 MB
|===                                                                                  |   4%   42 MB
|====                                                                                 |   4%   44 MB
|====                                                                                 |   5%   46 MB
|====                                                                                 |   5%   48 MB
|====                                                                                 |   5%   51 MB
|====                                                                                 |   5%   53 MB
|=====                                                                                |   5%   55 MB
|=====                                                                                |   6%   57 MB
|=====                                                                                |   6%   59 MB
|=====                                                                                |   6%   61 MB
|=====                                                                                |   6%   64 MB
|======                                                                               |   7%   66 MB
|======                                                                               |   7%   68 MB
|======                                                                               |   7%   70 MB
|======                                                                               |   7%   72 MB
|======                                                                               |   8%   74 MB
|=======                                                                              |   8%   77 MB
|=======                                                                              |   8%   79 MB
|=======                                                                              |   8%   81 MB
|=======                                                                              |   8%   83 MB
|=======                                                                              |   9%   85 MB
|========                                                                             |   9%   87 MB
|========                                                                             |   9%   90 MB
|========                                                                             |   9%   92 MB
|========                                                                             |  10%   94 MB
|========                                                                             |  10%   96 MB
|=========                                                                            |  10%   98 MB
|=========                                                                            |  10%  101 MB
|=========                                                                            |  11%  103 MB
|=========                                                                            |  11%  105 MB
|=========                                                                            |  11%  107 MB
|==========                                                                           |  11%  109 MB
|==========                                                                           |  12%  111 MB
|==========                                                                           |  12%  113 MB
|==========                                                                           |  12%  116 MB
|==========                                                                           |  12%  118 MB
|===========                                                                          |  12%  120 MB
|===========                                                                          |  13%  122 MB
|===========                                                                          |  13%  124 MB
|===========                                                                          |  13%  127 MB
|===========                                                                          |  13%  129 MB
|============                                                                         |  14%  131 MB
|============                                                                         |  14%  133 MB
|============                                                                         |  14%  135 MB
|============                                                                         |  14%  137 MB
|============                                                                         |  15%  140 MB
|=============                                                                        |  15%  142 MB
|=============                                                                        |  15%  144 MB
|=============                                                                        |  15%  146 MB
|=============                                                                        |  15%  148 MB
|=============                                                                        |  16%  150 MB
|==============                                                                       |  16%  153 MB
|==============                                                                       |  16%  155 MB
|==============                                                                       |  16%  157 MB
|==============                                                                       |  17%  159 MB
|==============                                                                       |  17%  161 MB
|===============                                                                      |  17%  163 MB
|===============                                                                      |  17%  165 MB
|===============                                                                      |  18%  168 MB
|===============                                                                      |  18%  170 MB
|===============                                                                      |  18%  172 MB
|================                                                                     |  18%  175 MB
|================                                                                     |  19%  177 MB
|================                                                                     |  19%  179 MB
|================                                                                     |  19%  181 MB
|================                                                                     |  19%  184 MB
|=================                                                                    |  19%  186 MB
|=================                                                                    |  20%  188 MB
|=================                                                                    |  20%  190 MB
|=================                                                                    |  20%  193 MB
|==================                                                                   |  20%  195 MB
|==================                                                                   |  21%  197 MB
|==================                                                                   |  21%  199 MB
|==================                                                                   |  21%  202 MB
|==================                                                                   |  21%  204 MB
|===================                                                                  |  22%  207 MB
|===================                                                                  |  22%  209 MB
|===================                                                                  |  22%  211 MB
|===================                                                                  |  23%  214 MB
|===================                                                                  |  23%  216 MB
|====================                                                                 |  23%  219 MB
|====================                                                                 |  23%  221 MB
|====================                                                                 |  24%  224 MB
|====================                                                                 |  24%  226 MB
|=====================                                                                |  24%  229 MB
|=====================                                                                |  24%  231 MB
|=====================                                                                |  25%  234 MB
|=====================                                                                |  25%  236 MB
|=====================                                                                |  25%  238 MB
|======================                                                               |  25%  240 MB
|======================                                                               |  26%  243 MB
|======================                                                               |  26%  245 MB
|======================                                                               |  26%  247 MB
|=======================                                                              |  26%  250 MB
|=======================                                                              |  27%  252 MB
|=======================                                                              |  27%  254 MB
|=======================                                                              |  27%  257 MB
|=======================                                                              |  27%  259 MB
|========================                                                             |  28%  262 MB
|========================                                                             |  28%  264 MB
|========================                                                             |  28%  267 MB
|========================                                                             |  28%  269 MB
|=========================                                                            |  29%  271 MB
|=========================                                                            |  29%  273 MB
|=========================                                                            |  29%  276 MB
|=========================                                                            |  29%  278 MB
|=========================                                                            |  30%  281 MB
|==========================                                                           |  30%  283 MB
|==========================                                                           |  30%  285 MB
|==========================                                                           |  30%  288 MB
|==========================                                                           |  31%  290 MB
|===========================                                                          |  31%  293 MB
|===========================                                                          |  31%  295 MB
|===========================                                                          |  31%  297 MB
|===========================                                                          |  32%  300 MB
|===========================                                                          |  32%  302 MB
|============================                                                         |  32%  304 MB
|============================                                                         |  32%  306 MB
|============================                                                         |  33%  308 MB
|============================                                                         |  33%  310 MB
|============================                                                         |  33%  312 MB
|=============================                                                        |  33%  314 MB
|=============================                                                        |  34%  317 MB
|=============================                                                        |  34%  319 MB
|=============================                                                        |  34%  321 MB
|=============================                                                        |  34%  323 MB
|==============================                                                       |  34%  326 MB
|==============================                                                       |  35%  328 MB
|==============================                                                       |  35%  330 MB
|==============================                                                       |  35%  332 MB
|==============================                                                       |  35%  334 MB
|===============================                                                      |  36%  336 MB
|===============================                                                      |  36%  338 MB
|===============================                                                      |  36%  341 MB
|===============================                                                      |  36%  343 MB
|===============================                                                      |  37%  345 MB
|================================                                                     |  37%  347 MB
|================================                                                     |  37%  349 MB
|================================                                                     |  37%  352 MB
|================================                                                     |  38%  354 MB
|================================                                                     |  38%  356 MB
|=================================                                                    |  38%  358 MB
|=================================                                                    |  38%  360 MB
|=================================                                                    |  38%  362 MB
|=================================                                                    |  39%  365 MB
|=================================                                                    |  39%  367 MB
|==================================                                                   |  39%  369 MB
|==================================                                                   |  39%  371 MB
|==================================                                                   |  40%  373 MB
|==================================                                                   |  40%  376 MB
|==================================                                                   |  40%  378 MB
|===================================                                                  |  40%  380 MB
|===================================                                                  |  41%  382 MB
|===================================                                                  |  41%  384 MB
|===================================                                                  |  41%  386 MB
|===================================                                                  |  41%  389 MB
|====================================                                                 |  41%  391 MB
|====================================                                                 |  42%  393 MB
|====================================                                                 |  42%  395 MB
|====================================                                                 |  42%  397 MB
|====================================                                                 |  42%  399 MB
|=====================================                                                |  43%  401 MB
|=====================================                                                |  43%  404 MB
|=====================================                                                |  43%  406 MB
|=====================================                                                |  43%  408 MB
|=====================================                                                |  44%  410 MB
|======================================                                               |  44%  412 MB
|======================================                                               |  44%  414 MB
|======================================                                               |  44%  417 MB
|======================================                                               |  44%  419 MB
|======================================                                               |  45%  421 MB
|=======================================                                              |  45%  423 MB
|=======================================                                              |  45%  425 MB
|=======================================                                              |  45%  428 MB
|=======================================                                              |  46%  430 MB
|=======================================                                              |  46%  432 MB
|========================================                                             |  46%  434 MB
|========================================                                             |  46%  436 MB
|========================================                                             |  47%  438 MB
|========================================                                             |  47%  440 MB
|========================================                                             |  47%  442 MB
|=========================================                                            |  47%  445 MB
|=========================================                                            |  47%  447 MB
|=========================================                                            |  48%  449 MB
|=========================================                                            |  48%  451 MB
|=========================================                                            |  48%  453 MB
|==========================================                                           |  48%  455 MB
|==========================================                                           |  49%  458 MB
|==========================================                                           |  49%  460 MB
|==========================================                                           |  49%  462 MB
|==========================================                                           |  49%  464 MB
|===========================================                                          |  50%  466 MB
|===========================================                                          |  50%  468 MB
|===========================================                                          |  50%  470 MB
|===========================================                                          |  50%  473 MB
|===========================================                                          |  50%  475 MB
|============================================                                         |  51%  477 MB
|============================================                                         |  51%  479 MB
|============================================                                         |  51%  481 MB
|============================================                                         |  51%  483 MB
|============================================                                         |  52%  486 MB
|=============================================                                        |  52%  488 MB
|=============================================                                        |  52%  490 MB
|=============================================                                        |  52%  492 MB
|=============================================                                        |  53%  494 MB
|=============================================                                        |  53%  496 MB
|==============================================                                       |  53%  498 MB
|==============================================                                       |  53%  500 MB
|==============================================                                       |  53%  503 MB
|==============================================                                       |  54%  505 MB
|==============================================                                       |  54%  507 MB
|===============================================                                      |  54%  509 MB
|===============================================                                      |  54%  511 MB
|===============================================                                      |  55%  514 MB
|===============================================                                      |  55%  516 MB
|===============================================                                      |  55%  518 MB
|================================================                                     |  55%  520 MB
|================================================                                     |  56%  522 MB
|================================================                                     |  56%  524 MB
|================================================                                     |  56%  527 MB
|================================================                                     |  56%  529 MB
|=================================================                                    |  57%  531 MB
|=================================================                                    |  57%  533 MB
|=================================================                                    |  57%  535 MB
|=================================================                                    |  57%  538 MB
|=================================================                                    |  57%  540 MB
|==================================================                                   |  58%  542 MB
|==================================================                                   |  58%  544 MB
|==================================================                                   |  58%  546 MB
|==================================================                                   |  58%  548 MB
|==================================================                                   |  59%  551 MB
|===================================================                                  |  59%  553 MB
|===================================================                                  |  59%  555 MB
|===================================================                                  |  59%  557 MB
|===================================================                                  |  60%  559 MB
|===================================================                                  |  60%  561 MB
|====================================================                                 |  60%  563 MB
|====================================================                                 |  60%  565 MB
|====================================================                                 |  60%  568 MB
|====================================================                                 |  61%  570 MB
|====================================================                                 |  61%  572 MB
|====================================================                                 |  61%  574 MB
|=====================================================                                |  61%  576 MB
|=====================================================                                |  62%  578 MB
|=====================================================                                |  62%  580 MB
|=====================================================                                |  62%  583 MB
|=====================================================                                |  62%  585 MB
|======================================================                               |  62%  587 MB
|======================================================                               |  63%  589 MB
|======================================================                               |  63%  591 MB
|======================================================                               |  63%  593 MB
|======================================================                               |  63%  595 MB
|=======================================================                              |  64%  597 MB
|=======================================================                              |  64%  599 MB
|=======================================================                              |  64%  602 MB
|=======================================================                              |  64%  604 MB
|=======================================================                              |  65%  606 MB
|========================================================                             |  65%  608 MB
|========================================================                             |  65%  610 MB
|========================================================                             |  65%  612 MB
|========================================================                             |  65%  614 MB
|========================================================                             |  66%  616 MB
|=========================================================                            |  66%  619 MB
|=========================================================                            |  66%  621 MB
|=========================================================                            |  66%  623 MB
|=========================================================                            |  67%  625 MB
|=========================================================                            |  67%  627 MB
|==========================================================                           |  67%  629 MB
|==========================================================                           |  67%  631 MB
|==========================================================                           |  67%  633 MB
|==========================================================                           |  68%  636 MB
|==========================================================                           |  68%  638 MB
|===========================================================                          |  68%  640 MB
|===========================================================                          |  68%  642 MB
|===========================================================                          |  69%  644 MB
|===========================================================                          |  69%  646 MB
|===========================================================                          |  69%  648 MB
|============================================================                         |  69%  651 MB
|============================================================                         |  70%  653 MB
|============================================================                         |  70%  655 MB
|============================================================                         |  70%  657 MB
|============================================================                         |  70%  659 MB
|=============================================================                        |  71%  661 MB
|=============================================================                        |  71%  664 MB
|=============================================================                        |  71%  666 MB
|=============================================================                        |  71%  668 MB
|=============================================================                        |  71%  670 MB
|==============================================================                       |  72%  672 MB
|==============================================================                       |  72%  674 MB
|==============================================================                       |  72%  676 MB
|==============================================================                       |  72%  679 MB
|==============================================================                       |  73%  681 MB
|===============================================================                      |  73%  683 MB
|===============================================================                      |  73%  685 MB
|===============================================================                      |  73%  687 MB
|===============================================================                      |  73%  689 MB
|===============================================================                      |  74%  691 MB
|================================================================                     |  74%  694 MB
|================================================================                     |  74%  696 MB
|================================================================                     |  74%  698 MB
|================================================================                     |  75%  700 MB
|================================================================                     |  75%  702 MB
|=================================================================                    |  75%  704 MB
|=================================================================                    |  75%  706 MB
|=================================================================                    |  76%  709 MB
|=================================================================                    |  76%  711 MB
|=================================================================                    |  76%  713 MB
|==================================================================                   |  76%  715 MB
|==================================================================                   |  76%  717 MB
|==================================================================                   |  77%  719 MB
|==================================================================                   |  77%  722 MB
|==================================================================                   |  77%  724 MB
|===================================================================                  |  77%  726 MB
|===================================================================                  |  78%  728 MB
|===================================================================                  |  78%  730 MB
|===================================================================                  |  78%  733 MB
|===================================================================                  |  78%  735 MB
|====================================================================                 |  79%  737 MB
|====================================================================                 |  79%  739 MB
|====================================================================                 |  79%  741 MB
|====================================================================                 |  79%  743 MB
|====================================================================                 |  80%  745 MB
|=====================================================================                |  80%  748 MB
|=====================================================================                |  80%  750 MB
|=====================================================================                |  80%  752 MB
|=====================================================================                |  80%  754 MB
|=====================================================================                |  81%  757 MB
|======================================================================               |  81%  759 MB
|======================================================================               |  81%  761 MB
|======================================================================               |  81%  763 MB
|======================================================================               |  82%  765 MB
|======================================================================               |  82%  767 MB
|=======================================================================              |  82%  769 MB
|=======================================================================              |  82%  772 MB
|=======================================================================              |  83%  774 MB
|=======================================================================              |  83%  776 MB
|=======================================================================              |  83%  778 MB
|========================================================================             |  83%  780 MB
|========================================================================             |  83%  783 MB
|========================================================================             |  84%  785 MB
|========================================================================             |  84%  787 MB
|========================================================================             |  84%  789 MB
|=========================================================================            |  84%  791 MB
|=========================================================================            |  85%  793 MB
|=========================================================================            |  85%  796 MB
|=========================================================================            |  85%  798 MB
|=========================================================================            |  85%  800 MB
|==========================================================================           |  86%  802 MB
|==========================================================================           |  86%  804 MB
|==========================================================================           |  86%  807 MB
|==========================================================================           |  86%  809 MB
|==========================================================================           |  87%  811 MB
|===========================================================================          |  87%  813 MB
|===========================================================================          |  87%  815 MB
|===========================================================================          |  87%  818 MB
|===========================================================================          |  87%  820 MB
|===========================================================================          |  88%  822 MB
|============================================================================         |  88%  824 MB
|============================================================================         |  88%  826 MB
|============================================================================         |  88%  829 MB
|============================================================================         |  89%  831 MB
|============================================================================         |  89%  833 MB
|=============================================================================        |  89%  835 MB
|=============================================================================        |  89%  837 MB
|=============================================================================        |  90%  839 MB
|=============================================================================        |  90%  842 MB
|=============================================================================        |  90%  844 MB
|==============================================================================       |  90%  846 MB
|==============================================================================       |  91%  848 MB
|==============================================================================       |  91%  850 MB
|==============================================================================       |  91%  853 MB
|==============================================================================       |  91%  855 MB
|===============================================================================      |  91%  857 MB
|===============================================================================      |  92%  859 MB
|===============================================================================      |  92%  862 MB
|===============================================================================      |  92%  864 MB
|===============================================================================      |  92%  866 MB
|================================================================================     |  93%  868 MB
|================================================================================     |  93%  870 MB
|================================================================================     |  93%  872 MB
|================================================================================     |  93%  875 MB
|================================================================================     |  94%  877 MB
|=================================================================================    |  94%  879 MB
|=================================================================================    |  94%  881 MB
|=================================================================================    |  94%  883 MB
|=================================================================================    |  95%  885 MB
|=================================================================================    |  95%  887 MB
|==================================================================================   |  95%  890 MB
|==================================================================================   |  95%  892 MB
|==================================================================================   |  95%  894 MB
|==================================================================================   |  96%  896 MB
|==================================================================================   |  96%  898 MB
|===================================================================================  |  96%  901 MB
|===================================================================================  |  96%  903 MB
|===================================================================================  |  97%  905 MB
|===================================================================================  |  97%  907 MB
|===================================================================================  |  97%  909 MB
|==================================================================================== |  97%  912 MB
|==================================================================================== |  98%  914 MB
|==================================================================================== |  98%  916 MB
|==================================================================================== |  98%  919 MB
|=====================================================================================|  98%  921 MB
|=====================================================================================|  99%  923 MB
|=====================================================================================|  99%  926 MB
|=====================================================================================|  99%  928 MB
|=====================================================================================|  99%  930 MB
|======================================================================================| 100%  932 MB
> cps <- as.data.frame(cps)
> names(cps) <- toupper(names(cps))
> 
> # -----------------------------
> # 3) NUMERICAL / INFERENCE HELPERS
> # -----------------------------
> safe_vcov <- function(V, eps = 0) {
+   V <- (V + t(V)) / 2
+   d <- diag(V)
+   d[!is.finite(d)] <- NA_real_
+   d[d < eps] <- eps
+   diag(V) <- d
+   V
+ }
> 
> safe_solve <- function(A, ridge = 1e-12) {
+   A <- (A + t(A)) / 2
+   out <- tryCatch(solve(A), error = function(e) NULL)
+   if (!is.null(out)) return(out)
+   # Ridge fallback if singular
+   solve(A + diag(ridge, nrow(A)))
+ }
> 
> qform <- function(x, V) {
+   V <- safe_vcov(V, eps = 0)
+   val <- as.numeric(t(x) %*% V %*% x)
+   if (!is.finite(val)) return(NA_real_)
+   sqrt(max(0, val))
+ }
> 
> safe_coeftable <- function(model, V, terms_keep = NULL) {
+   V <- safe_vcov(V, eps = 0)
+   b <- coef(model)
+   se <- sqrt(diag(V))
+   tval <- b / se
+   df  <- stats::df.residual(model)
+   pval <- 2 * stats::pt(abs(tval), df = df, lower.tail = FALSE)
+   out <- cbind(Estimate = b, `Std. Error` = se, `t value` = tval, `Pr(>|t|)` = pval)
+   if (!is.null(terms_keep)) out <- out[terms_keep, , drop = FALSE]
+   out
+ }
> 
> wald_test_linear <- function(model, V, terms) {
+   # H0: each named term coefficient = 0  (joint)
+   b <- coef(model)
+   cn <- names(b)
+   idx <- match(terms, cn)
+   idx <- idx[!is.na(idx)]
+   if (length(idx) == 0) {
+     return(tibble(test = "Joint Wald", q = 0, stat = NA_real_, p = NA_real_))
+   }
+   R <- matrix(0, nrow = length(idx), ncol = length(b))
+   for (i in seq_along(idx)) R[i, idx[i]] <- 1
+   V <- safe_vcov(V, eps = 0)
+   RVR <- R %*% V %*% t(R)
+   inv <- safe_solve(RVR)
+   q <- nrow(R)
+   W <- as.numeric(t(R %*% b) %*% inv %*% (R %*% b))
+   p <- stats::pchisq(W, df = q, lower.tail = FALSE)
+   tibble(test = "Joint Wald (Chi-square)", q = q, stat = W, p = p)
+ }
> 
> w_mean <- function(x, w) sum(w * x, na.rm = TRUE) / sum(w, na.rm = TRUE)
> 
> # -----------------------------
> # 4) BUILD ANALYSIS DF HELPER
> # -----------------------------
> build_df_cps <- function(cps, age_min, age_max, yr_lo, yr_hi, break_year) {
+   cps %>%
+     mutate(
+       birth_year = YEAR - AGE,
+       weight = ifelse(!is.na(ASECWT) & ASECWT > 0, ASECWT, WTFINL),
+ 
+       cohab    = ifelse(is.na(PECOHAB), FALSE, PECOHAB > 0),
+       married  = !is.na(MARST) & as.integer(MARST) == 1,
+       single01 = as.integer((!married) & (!cohab)),
+ 
+       sex  = ifelse(as.integer(SEX) == 1, "Men", "Women"),
+       male = as.integer(sex == "Men")
+     ) %>%
+     filter(
+       YEAR >= yr_lo, YEAR <= yr_hi,
+       AGE >= age_min, AGE <= age_max,
+       !is.na(weight), weight > 0,
+       !is.na(single01), !is.na(male)
+     ) %>%
+     mutate(
+       year_c = YEAR - break_year,
+       post   = as.integer(YEAR >= break_year),
+       post_year_c = post * year_c
+     )
+ }
> 
> vcov_cluster <- function(model, df, which = c("two_way","year","birth")) {
+   which <- match.arg(which)
+   if (which == "year") {
+     V <- sandwich::vcovCL(model, cluster = df$YEAR, type = "HC1")
+   } else if (which == "birth") {
+     V <- sandwich::vcovCL(model, cluster = df$birth_year, type = "HC1")
+   } else {
+     V <- sandwich::vcovCL(model, cluster = df[, c("birth_year","YEAR")], type = "HC1")
+   }
+   safe_vcov(V)
+ }
> 
> # ============================================================
> # A) TABLE K1 — CPS singlehood rates by gender & period (25–34)
> # Pre: 2008–2011, Post: 2013–2016, omit 2012
> # ============================================================
> tab_age_min <- 25
> tab_age_max <- 34
> tab_pre_years  <- 2008:2011
> tab_post_years <- 2013:2016
> tab_omit_years <- 2012
> 
> df_tab <- cps %>%
+   mutate(
+     weight = ifelse(!is.na(ASECWT) & ASECWT > 0, ASECWT, WTFINL),
+     cohab    = ifelse(is.na(PECOHAB), FALSE, PECOHAB > 0),
+     married  = !is.na(MARST) & as.integer(MARST) == 1,
+     single01 = as.integer((!married) & (!cohab)),
+     sex  = ifelse(as.integer(SEX) == 1, "Men", "Women")
+   ) %>%
+   filter(
+     AGE >= tab_age_min, AGE <= tab_age_max,
+     YEAR %in% c(tab_pre_years, tab_post_years),
+     !YEAR %in% tab_omit_years,
+     !is.na(weight), weight > 0,
+     !is.na(single01),
+     sex %in% c("Men","Women")
+   ) %>%
+   mutate(
+     period = case_when(
+       YEAR %in% tab_pre_years  ~ "Pre (2008–2011)",
+       YEAR %in% tab_post_years ~ "Post (2013–2016)",
+       TRUE ~ NA_character_
+     )
+   ) %>%
+   filter(!is.na(period))
> 
> table_k1 <- df_tab %>%
+   group_by(sex, period) %>%
+   summarise(
+     rate_single  = w_mean(single01, weight),
+     n_unweighted = dplyr::n(),
+     N_weighted   = sum(weight, na.rm = TRUE),
+     .groups = "drop"
+   ) %>%
+   arrange(sex, period)
> 
> write_csv(table_k1, file.path(out_dir, "table_k1_cps_singlehood_rates_25_34.csv"))

[1mwrote[0m [32m2.15GB[0m in [36m 0s[0m, [32m2.15GB/s[0m
                                                                                                   
> 
> # ============================================================
> # K2) DIFFERENCE-IN-DIFFERENCES (headline robustness)
> # Spec (per Appendix text): single01 ~ male + post + male×post + age FE + year FE
> # Sample: Ages 25–34, years 2008–2011 vs 2013–2016 (omit 2012)
> # Cluster: survey YEAR (plus we also report two-way & birth-year in same table)
> # ============================================================
> df_did <- cps %>%
+   mutate(
+     birth_year = YEAR - AGE,
+     weight = ifelse(!is.na(ASECWT) & ASECWT > 0, ASECWT, WTFINL),
+     cohab    = ifelse(is.na(PECOHAB), FALSE, PECOHAB > 0),
+     married  = !is.na(MARST) & as.integer(MARST) == 1,
+     single01 = as.integer((!married) & (!cohab)),
+     male = as.integer(as.integer(SEX) == 1),
+     post = as.integer(YEAR %in% tab_post_years)
+   ) %>%
+   filter(
+     AGE >= tab_age_min, AGE <= tab_age_max,
+     YEAR %in% c(tab_pre_years, tab_post_years),
+     !YEAR %in% tab_omit_years,
+     !is.na(weight), weight > 0,
+     !is.na(single01), !is.na(male)
+   )
> 
> m_did <- lm(single01 ~ male * post + factor(AGE) + factor(YEAR),
+             data = df_did, weights = weight)
> 
> V_did_year <- vcov_cluster(m_did, df_did, "year")
> V_did_birth <- vcov_cluster(m_did, df_did, "birth")
> V_did_tw   <- vcov_cluster(m_did, df_did, "two_way")
> 
> term_did <- "male:post"
> ct_year  <- safe_coeftable(m_did, V_did_year,  terms_keep = term_did)
Warning messages:
1: In b/se :
  longer object length is not a multiple of shorter object length
2: In cbind(Estimate = b, `Std. Error` = se, `t value` = tval, `Pr(>|t|)` = pval) :
  number of rows of result is not a multiple of vector length (arg 2)
> ct_birth <- safe_coeftable(m_did, V_did_birth, terms_keep = term_did)
Warning messages:
1: In b/se :
  longer object length is not a multiple of shorter object length
2: In cbind(Estimate = b, `Std. Error` = se, `t value` = tval, `Pr(>|t|)` = pval) :
  number of rows of result is not a multiple of vector length (arg 2)
> ct_tw    <- safe_coeftable(m_did, V_did_tw,    terms_keep = term_did)
Warning messages:
1: In b/se :
  longer object length is not a multiple of shorter object length
2: In cbind(Estimate = b, `Std. Error` = se, `t value` = tval, `Pr(>|t|)` = pval) :
  number of rows of result is not a multiple of vector length (arg 2)
> 
> k2_out <- bind_rows(
+   tibble(cluster = "YEAR-only",    term = term_did,
+          estimate = ct_year[1,1], se = ct_year[1,2], t = ct_year[1,3], p = ct_year[1,4]),
+   tibble(cluster = "Birth-year-only", term = term_did,
+          estimate = ct_birth[1,1], se = ct_birth[1,2], t = ct_birth[1,3], p = ct_birth[1,4]),
+   tibble(cluster = "Two-way (birth_year, YEAR)", term = term_did,
+          estimate = ct_tw[1,1], se = ct_tw[1,2], t = ct_tw[1,3], p = ct_tw[1,4])
+ )
> 
> write_csv(k2_out, file.path(out_dir, "k2_did_estimates.csv"))

[1mwrote[0m [32m2.15GB[0m in [36m 0s[0m, [32m2.15GB/s[0m
                                                                                                   
> 
> # ============================================================
> # K3/K4/K5) EVENT STUDY (Figure K1) + PRETREND TESTS
> # Paper-described Figure K1: male × YEAR coefficients, baseline 2011, cutoff 2012
> # Sample: ages 28–32, years 2004–2020
> # Also exports:
> #  - joint pretrend Wald tests for k<0 (excluding baseline 2011)
> #  - pre-slope test: regress pre-period coefficients on event time
> # ============================================================
> es_age_min <- 28
> es_age_max <- 32
> es_yr_lo   <- 2004
> es_yr_hi   <- 2020
> cutoff_year   <- 2012
> baseline_year <- 2011
> 
> df_es <- build_df_cps(cps, es_age_min, es_age_max, es_yr_lo, es_yr_hi, cutoff_year)
> 
> # Event-study regression (matches your earlier approach, but now we extract coefficients explicitly)
> m_es <- lm(single01 ~ factor(YEAR) * male + factor(AGE), data = df_es, weights = weight)
> 
> V_es_year  <- vcov_cluster(m_es, df_es, "year")
> V_es_birth <- vcov_cluster(m_es, df_es, "birth")
> V_es_tw    <- vcov_cluster(m_es, df_es, "two_way")
> 
> extract_es <- function(V, label) {
+   b <- coef(m_es)
+   cn <- names(b)
+ 
+   # coefficient name for the baseline male-year interaction:
+   # factor(YEAR)YEAR:male  (baseline year is absorbed; for baseline we set effect=0)
+   # We will build event time k = YEAR - cutoff_year and set baseline_year effect to 0.
+ 
+   years <- sort(unique(df_es$YEAR))
+   # For each year, compute "male effect relative to women" at that year:
+   # effect_male(year) = male main effect + male:factor(YEAR) interaction (if non-baseline level exists)
+   # BUT because factor(YEAR) includes all years, one year is the reference category.
+   # We don't actually care which year is reference, because we re-center to baseline_year below.
+ 
+   # Find the YEAR reference level used by R:
+   ref_year <- as.integer(levels(factor(df_es$YEAR))[1])
+ 
+   # helper to fetch interaction name
+   get_int_name <- function(y) paste0("factor(YEAR)", y, ":male")
+ 
+   # male main effect:
+   b_male <- if ("male" %in% cn) b["male"] else 0
+   V <- safe_vcov(V, eps = 0)
+ 
+   # Build coefficient series for male-vs-female gap at each YEAR
+   out <- lapply(years, function(y) {
+     # effect at year y:
+     # if y is reference level, no interaction term exists
+     int_name <- get_int_name(y)
+     eff <- b_male + if (int_name %in% cn) b[int_name] else 0
+ 
+     # delta method SE for eff:
+     # eff = e' b where e has 1 on "male" and 1 on int_name (if present)
+     e <- rep(0, length(b)); names(e) <- cn
+     if ("male" %in% cn) e["male"] <- 1
+     if (int_name %in% cn) e[int_name] <- 1
+     se <- qform(e, V)
+ 
+     tibble(YEAR = y, k = y - cutoff_year,
+            male_gap = eff, se = se)
+   }) %>% bind_rows()
+ 
+   # Re-center to baseline_year (k = -1)
+   base_eff <- out %>% filter(YEAR == baseline_year) %>% pull(male_gap)
+   base_se  <- out %>% filter(YEAR == baseline_year) %>% pull(se)
+ 
+   out <- out %>%
+     mutate(
+       gap_rel = male_gap - base_eff,
+       # conservative SE for difference (no cov) — matches your earlier plotting logic
+       se_rel  = sqrt(se^2 + base_se^2),
+       lo_rel  = gap_rel - 1.96 * se_rel,
+       hi_rel  = gap_rel + 1.96 * se_rel,
+       cluster = label
+     )
+   out
+ }
> 
> es_year  <- extract_es(V_es_year,  "YEAR-only")
> es_birth <- extract_es(V_es_birth, "Birth-year-only")
> es_tw    <- extract_es(V_es_tw,    "Two-way (birth_year, YEAR)")
> 
> es_plotdata <- bind_rows(es_year, es_birth, es_tw) %>%
+   arrange(cluster, YEAR)
> 
> write_csv(es_plotdata, file.path(out_dir, "figure_k1_event_study_plotdata.csv"))

[1mwrote[0m [32m3.64kB[0m in [36m 0s[0m, [32m242.07MB/s[0m
                                                                                                   
[1mwrote[0m [32m2.15GB[0m in [36m 0s[0m, [32m2.15GB/s[0m
                                                                                                   
> 
> # Figure K1 plot: show the two-way clustered series by default (closest to your main Appendix K)
> p_k1 <- es_tw %>%
+   ggplot(aes(x = k, y = 100 * gap_rel)) +
+   geom_hline(yintercept = 0, linetype = "dashed") +
+   geom_vline(xintercept = 0, linetype = "dashed") +
+   geom_ribbon(aes(ymin = 100 * lo_rel, ymax = 100 * hi_rel), alpha = 0.18) +
+   geom_line(linewidth = 0.9) +
+   geom_point(size = 2) +
+   labs(
+     x = "Event time (years relative to 2012 cutoff)",
+     y = "Male–female gap change (pp; relative to 2011)",
+     title = "Figure K1. CPS Event Study: Male Relative Singlehood Around 2012 (Two-way clustered)"
+   ) +
+   theme_minimal(base_size = 12)
> 
> ggsave(file.path(out_dir, "figure_k1_event_study.png"), p_k1, width = 7.2, height = 4.6, dpi = 300)
> 
> # Also export the coefficient-style table the Appendix describes:
> # Here we export the (re-centered) year-by-year series (two-way) as the “Figure K1 coefficients”.
> es_coeffs_out <- es_tw %>%
+   transmute(
+     YEAR, k,
+     estimate = gap_rel,
+     se = se_rel,
+     lo = lo_rel,
+     hi = hi_rel
+   )
> write_csv(es_coeffs_out, file.path(out_dir, "figure_k1_event_study_coefficients.csv"))

[1mwrote[0m [32m2.15GB[0m in [36m 0s[0m, [32m2.15GB/s[0m
                                                                                                   
> 
> # Joint pre-trend tests (k < 0 excluding baseline k = -1)
> # We do this properly off the regression coefficients using Wald tests, for each V.
> # Terms to test are the male×factor(YEAR) interactions for pre-years excluding baseline.
> make_pretrend_terms <- function() {
+   yrs_pre <- sort(unique(df_es$YEAR[df_es$YEAR < cutoff_year]))
+   yrs_pre <- yrs_pre[yrs_pre != baseline_year]
+   paste0("factor(YEAR)", yrs_pre, ":male")
+ }
> 
> pre_terms <- make_pretrend_terms()
> 
> pretest_year  <- wald_test_linear(m_es, V_es_year,  pre_terms)  %>% mutate(cluster = "YEAR-only")
> pretest_birth <- wald_test_linear(m_es, V_es_birth, pre_terms)  %>% mutate(cluster = "Birth-year-only")
> pretest_tw    <- wald_test_linear(m_es, V_es_tw,    pre_terms)  %>% mutate(cluster = "Two-way (birth_year, YEAR)")
> 
> pretests <- bind_rows(pretest_year, pretest_birth, pretest_tw) %>%
+   select(cluster, everything())
> 
> write_csv(pretests, file.path(out_dir, "figure_k1_joint_pretrend_tests.csv"))

[1mwrote[0m [32m2.15GB[0m in [36m 0s[0m, [32m2.15GB/s[0m
                                                                                                   
> 
> # Pre-slope test: regress pre-period coefficient estimates on event time k (<0, excluding -1)
> # We use the (re-centered) two-way series; weights are inverse-variance (1/se^2).
> pre_slope_df <- es_tw %>%
+   filter(k < 0, k != -1) %>%
+   mutate(w = 1 / (se_rel^2))
> 
> m_pre_slope <- lm(gap_rel ~ k, data = pre_slope_df, weights = w)
> 
> pre_slope_out <- tibble(
+   test = "Pre-slope test: gap_rel ~ k (k<0 excluding -1), WLS inverse-var",
+   slope = coef(m_pre_slope)["k"],
+   se_slope = summary(m_pre_slope)$coef["k","Std. Error"],
+   t = summary(m_pre_slope)$coef["k","t value"],
+   p = summary(m_pre_slope)$coef["k","Pr(>|t|)"],
+   n = nrow(pre_slope_df)
+ )
> 
> write_csv(pre_slope_out, file.path(out_dir, "figure_k1_pre_slope_test.csv"))

[1mwrote[0m [32m2.15GB[0m in [36m 0s[0m, [32m2.15GB/s[0m
                                                                                                   
> 
> # ============================================================
> # K5) ITS predicted levels by gender (Figure K2) + key coef tables
> # Sample: ages 28–32, years 2004–2020, break=2012
> # ============================================================
> its_age_min <- 28
> its_age_max <- 32
> its_yr_lo   <- 2004
> its_yr_hi   <- 2020
> break_year  <- 2012
> 
> df_its <- build_df_cps(cps, its_age_min, its_age_max, its_yr_lo, its_yr_hi, break_year)
> 
> m_its <- lm(
+   single01 ~ male * (year_c + post + post_year_c) + factor(AGE),
+   data = df_its, weights = weight
+ )
> 
> V_its_tw <- vcov_cluster(m_its, df_its, "two_way")
> 
> terms_want <- c("year_c","male:year_c","post","post_year_c","male:post","male:post_year_c")
> its_coef_table <- safe_coeftable(m_its, V_its_tw, terms_keep = terms_want)
> 
> its_coef_df <- as.data.frame(its_coef_table)
> its_coef_df$term <- rownames(its_coef_df)
> rownames(its_coef_df) <- NULL
> its_coef_df <- its_coef_df %>% select(term, Estimate, `Std. Error`, `t value`, `Pr(>|t|)`)
> write_csv(its_coef_df, file.path(out_dir, "its_key_coefficients_two_way_clustered.csv"))

[1mwrote[0m [32m2.15GB[0m in [36m 0s[0m, [32m2.15GB/s[0m
                                                                                                   
> 
> # Pretrend within ITS: H0 male:year_c = 0 (pre-break slope difference)
> pretrend_test <- safe_coeftable(m_its, V_its_tw, terms_keep = "male:year_c")
> write_csv(
+   tibble(
+     test = "Pre-trend slope difference (Men vs Women), pre-break",
+     term = "male:year_c",
+     estimate = pretrend_test[1,1],
+     se = pretrend_test[1,2],
+     t = pretrend_test[1,3],
+     p = pretrend_test[1,4]
+   ),
+   file.path(out_dir, "its_pretrend_test.csv")
+ )

[1mwrote[0m [32m2.15GB[0m in [36m 0s[0m, [32m2.15GB/s[0m
                                                                                                   
> 
> # Prediction grid YEAR × sex × AGE, then age-average (average's xbar then CI)
> age_support2 <- sort(unique(df_its$AGE))
> age_weights2 <- df_its %>%
+   group_by(AGE) %>%
+   summarise(w = sum(weight, na.rm = TRUE), .groups = "drop") %>%
+   mutate(w = w / sum(w)) %>%
+   right_join(tibble(AGE = age_support2), by = "AGE") %>%
+   mutate(w = ifelse(is.na(w), 0, w))
> 
> years2 <- sort(unique(df_its$YEAR))
> grid_its <- tidyr::crossing(YEAR = years2, male = c(0,1), AGE = age_support2) %>%
+   mutate(
+     year_c = YEAR - break_year,
+     post   = as.integer(YEAR >= break_year),
+     post_year_c = post * year_c,
+     sex = ifelse(male == 1, "Men", "Women")
+   ) %>%
+   left_join(age_weights2, by = "AGE")
> 
> rhs_terms <- delete.response(terms(m_its))
> X <- model.matrix(rhs_terms, data = grid_its)
> b <- coef(m_its)
> 
> grid_its$fit_row <- as.numeric(X %*% b)
> 
> pred_levels <- grid_its %>%
+   mutate(row_id = row_number()) %>%
+   group_by(YEAR, sex, male) %>%
+   summarise(
+     fit  = sum(w * fit_row),
+     xbar = list(colSums(X[row_id, , drop = FALSE] * w)),
+     .groups = "drop"
+   ) %>%
+   mutate(
+     se = vapply(xbar, qform, numeric(1), V = V_its_tw),
+     lo = fit - 1.96 * se,
+     hi = fit + 1.96 * se
+   ) %>%
+   select(YEAR, sex, male, fit, lo, hi, se) %>%
+   arrange(sex, YEAR)
> 
> write_csv(pred_levels, file.path(out_dir, "figure_k2_its_predicted_levels.csv"))

[1mwrote[0m [32m2.19kB[0m in [36m 0s[0m, [32m114.71MB/s[0m
                                                                                                   
[1mwrote[0m [32m2.15GB[0m in [36m 0s[0m, [32m2.15GB/s[0m
                                                                                                   
> 
> p_k2_overlay <- ggplot(pred_levels, aes(x = YEAR, y = fit, linetype = sex)) +
+   geom_ribbon(aes(ymin = lo, ymax = hi, group = sex), alpha = 0.18) +
+   geom_line(linewidth = 0.9) +
+   geom_vline(xintercept = break_year, linetype = "dashed") +
+   scale_y_continuous(labels = function(x) sprintf("%.0f%%", 100 * x)) +
+   labs(
+     x = NULL,
+     y = "Predicted not married & not cohabiting (share)",
+     title = "Figure K2. Interrupted Time Series: Predicted Singlehood by Gender (CPS, Ages 28–32)",
+     subtitle = paste0("Breakpoint at ", break_year, "; predictions age-averaged; two-way clustered SEs")
+   ) +
+   theme_minimal(base_size = 12) +
+   theme(legend.title = element_blank())
> 
> ggsave(file.path(out_dir, "figure_k2_its_predicted_levels_overlay.png"),
+        p_k2_overlay, width = 7.2, height = 4.6, dpi = 300)
> 
> p_k2_panels <- ggplot(pred_levels, aes(x = YEAR, y = fit)) +
+   geom_ribbon(aes(ymin = lo, ymax = hi), alpha = 0.18) +
+   geom_line(linewidth = 0.9) +
+   geom_vline(xintercept = break_year, linetype = "dashed") +
+   facet_wrap(~ sex, ncol = 1) +
+   scale_y_continuous(labels = function(x) sprintf("%.0f%%", 100 * x)) +
+   labs(
+     x = NULL,
+     y = "Predicted not married & not cohabiting (share)",
+     title = "Figure K2. Interrupted Time Series: Predicted Singlehood by Gender (Panels)",
+     subtitle = paste0("Breakpoint at ", break_year, "; predictions age-averaged; two-way clustered SEs")
+   ) +
+   theme_minimal(base_size = 12) +
+   theme(strip.text = element_text(face = "bold"))
> 
> ggsave(file.path(out_dir, "figure_k2_its_predicted_levels_panels.png"),
+        p_k2_panels, width = 7.0, height = 6.2, dpi = 300)
> 
> # ============================================================
> # K5a) CLUSTERING SENSITIVITY — key ITS terms across SE specs
> # Reports year-only vs birth-only vs two-way for the 6 key ITS terms
> # ============================================================
> V_its_year  <- vcov_cluster(m_its, df_its, "year")
> V_its_birth <- vcov_cluster(m_its, df_its, "birth")
> 
> ct_its_year  <- safe_coeftable(m_its, V_its_year,  terms_keep = terms_want)
> ct_its_birth <- safe_coeftable(m_its, V_its_birth, terms_keep = terms_want)
> ct_its_tw    <- safe_coeftable(m_its, V_its_tw,    terms_keep = terms_want)
> 
> pack_ct <- function(ct, cluster_label) {
+   df <- as.data.frame(ct)
+   df$term <- rownames(df)
+   rownames(df) <- NULL
+   df %>%
+     transmute(
+       cluster = cluster_label,
+       term,
+       estimate = Estimate,
+       se = `Std. Error`,
+       t = `t value`,
+       p = `Pr(>|t|)`
+     )
+ }
> 
> k5a_out <- bind_rows(
+   pack_ct(ct_its_year,  "YEAR-only"),
+   pack_ct(ct_its_birth, "Birth-year-only"),
+   pack_ct(ct_its_tw,    "Two-way (birth_year, YEAR)")
+ )
> 
> write_csv(k5a_out, file.path(out_dir, "k5a_clustering_sensitivity_its_key_terms.csv"))

[1mwrote[0m [32m2.15GB[0m in [36m 0s[0m, [32m2.15GB/s[0m
                                                                                                   
> 
> # ============================================================
> # K5b) Breakpoint sensitivity (2009–2015): male:post_year_c
> # Uses two-way clustered SEs (to match main Appendix presentation)
> # ============================================================
> breaks <- 2009:2015
> 
> bp_sens <- lapply(breaks, function(bk) {
+   df_b <- build_df_cps(cps, its_age_min, its_age_max, its_yr_lo, its_yr_hi, bk)
+   m_b <- lm(single01 ~ male * (year_c + post + post_year_c) + factor(AGE),
+             data = df_b, weights = weight)
+   V_b <- vcov_cluster(m_b, df_b, "two_way")
+   term <- "male:post_year_c"
+   ct <- safe_coeftable(m_b, V_b, terms_keep = term)
+ 
+   tibble(
+     break_year = bk,
+     term = term,
+     estimate = ct[1,1],
+     se = ct[1,2],
+     t = ct[1,3],
+     p = ct[1,4]
+   )
+ }) %>% bind_rows()
> 
> write_csv(bp_sens, file.path(out_dir, "breakpoint_sensitivity_2009_2015.csv"))

[1mwrote[0m [32m2.15GB[0m in [36m 0s[0m, [32m2.15GB/s[0m
                                                                                                   
> 
> p_bp <- ggplot(bp_sens, aes(x = break_year, y = estimate)) +
+   geom_hline(yintercept = 0, linetype = "dashed") +
+   geom_line(linewidth = 0.9) +
+   geom_point(size = 2) +
+   geom_errorbar(aes(ymin = estimate - 1.96 * se, ymax = estimate + 1.96 * se), width = 0.15) +
+   labs(
+     x = "Breakpoint year",
+     y = "Male-specific post-break slope change (probability units per year)",
+     title = "Breakpoint sensitivity: male:post_year_c (two-way clustered 95% CI)"
+   ) +
+   theme_minimal(base_size = 12)
> 
> ggsave(file.path(out_dir, "breakpoint_sensitivity_2009_2015.png"),
+        p_bp, width = 7.0, height = 4.6, dpi = 300)
> 
> # ============================================================
> # Save session info
> # ============================================================
> sink(file.path(out_dir, "sessionInfo.txt"))
> print(sessionInfo())
> sink()
> 
> # ============================================================
> # Quick sanity check
> # ============================================================
> check_files <- c(
+   "table_k1_cps_singlehood_rates_25_34.csv",
+   "k2_did_estimates.csv",
+   "figure_k1_event_study_coefficients.csv",
+   "figure_k1_event_study_plotdata.csv",
+   "figure_k1_joint_pretrend_tests.csv",
+   "figure_k1_pre_slope_test.csv",
+   "figure_k1_event_study.png",
+   "figure_k2_its_predicted_levels.csv",
+   "its_key_coefficients_two_way_clustered.csv",
+   "its_pretrend_test.csv",
+   "figure_k2_its_predicted_levels_overlay.png",
+   "figure_k2_its_predicted_levels_panels.png",
+   "k5a_clustering_sensitivity_its_key_terms.csv",
+   "breakpoint_sensitivity_2009_2015.csv",
+   "breakpoint_sensitivity_2009_2015.png",
+   "sessionInfo.txt"
+ )
> 
> cat("\n================== DONE (Appendix K COMPLETE) ==================\n")

================== DONE (Appendix K COMPLETE) ==================
> cat("Wrote outputs to: ", normalizePath(out_dir), "\n", sep = "")
Wrote outputs to: C:\Users\joshu\Documents\outputs
> cat("\nFile sizes (bytes):\n")

File sizes (bytes):
> for (f in check_files) {
+   fp <- file.path(out_dir, f)
+   if (file.exists(fp)) {
+     info <- file.info(fp)
+     cat(sprintf("  %-55s %12.0f\n", f, info$size))
+   } else {
+     cat(sprintf("  %-55s MISSING\n", f))
+   }
+ }
  table_k1_cps_singlehood_rates_25_34.csv                          314
  k2_did_estimates.csv                                             353
  figure_k1_event_study_coefficients.csv                          1572
  figure_k1_event_study_plotdata.csv                              7699
  figure_k1_joint_pretrend_tests.csv                               235
  figure_k1_pre_slope_test.csv                                     178
  figure_k1_event_study.png                                     156042
  figure_k2_its_predicted_levels.csv                              3139
  its_key_coefficients_two_way_clustered.csv                       594
  its_pretrend_test.csv                                            178
  figure_k2_its_predicted_levels_overlay.png                    181690
  figure_k2_its_predicted_levels_panels.png                     187215
  k5a_clustering_sensitivity_its_key_terms.csv                    2014
  breakpoint_sensitivity_2009_2015.csv                             759
  breakpoint_sensitivity_2009_2015.png                          109625
  sessionInfo.txt                                                 1615
> cat("===============================================================\n\n")
===============================================================
